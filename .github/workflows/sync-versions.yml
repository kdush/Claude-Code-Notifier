name: Version Sync and Maintenance

on:
  # å½“å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶è§¦å‘
  release:
    types: [published]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Sync type'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - force-pypi
        - force-git
        - test-only
        
  # å®šæ—¶æ£€æŸ¥ï¼ˆæ¯å¤©æ—©ä¸Š10ç‚¹ï¼‰
  schedule:
    - cron: '0 10 * * *'

jobs:
  version-sync:
    runs-on: ubuntu-latest
    outputs:
      pypi-version: ${{ steps.versions.outputs.pypi-version }}
      git-version: ${{ steps.versions.outputs.git-version }}
      sync-needed: ${{ steps.versions.outputs.sync-needed }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests packaging
    
    - name: Get version information
      id: versions
      run: |
        # èŽ·å–PyPIç‰ˆæœ¬ - ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…stdinæ‰§è¡Œé—®é¢˜
        cat > get_pypi_version.py << 'EOF'
import requests
import json
try:
    response = requests.get('https://pypi.org/pypi/claude-code-notifier/json')
    data = response.json()
    print(data['info']['version'])
except:
    print('0.0.0')
EOF
        PYPI_VERSION=$(python3 get_pypi_version.py)
        rm -f get_pypi_version.py
        
        # èŽ·å–Gitç‰ˆæœ¬
        GIT_VERSION=$(python3 -c "
        import sys; sys.path.insert(0, 'src')
        from claude_notifier.__version__ import __version__
        print(__version__)
        ")
        
        echo "pypi-version=$PYPI_VERSION" >> $GITHUB_OUTPUT
        echo "git-version=$GIT_VERSION" >> $GITHUB_OUTPUT
        
        # ç‰ˆæœ¬æ¯”è¾ƒ - ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…stdinæ‰§è¡Œé—®é¢˜
        cat > compare_versions.py << EOF
from packaging.version import Version
pypi_v = "$PYPI_VERSION"
git_v = "$GIT_VERSION"

try:
    if Version(git_v) > Version(pypi_v):
        print("git-ahead")
    elif Version(pypi_v) > Version(git_v):
        print("pypi-ahead") 
    else:
        print("synced")
except:
    print("unknown")
EOF
        SYNC_NEEDED=$(python3 compare_versions.py)
        rm -f compare_versions.py
        
        echo "sync-needed=$SYNC_NEEDED" >> $GITHUB_OUTPUT
        
        echo "ðŸ“Š Version Status:"
        echo "  PyPI: $PYPI_VERSION"
        echo "  Git:  $GIT_VERSION" 
        echo "  Sync: $SYNC_NEEDED"
    
    - name: Update installation scripts
      if: steps.versions.outputs.sync-needed != 'synced'
      run: |
        # æ›´æ–°install.shä¸­çš„é»˜è®¤ç‰ˆæœ¬
        LATEST_VERSION="${{ steps.versions.outputs.git-version }}"
        
        # åˆ›å»ºç‰ˆæœ¬åŒæ­¥æŠ¥å‘Š
        cat > version-sync-report.md << EOF
        # ðŸ”„ ç‰ˆæœ¬åŒæ­¥æŠ¥å‘Š
        
        **ç”Ÿæˆæ—¶é—´**: $(date -Iseconds)
        **PyPIç‰ˆæœ¬**: ${{ steps.versions.outputs.pypi-version }}
        **Gitç‰ˆæœ¬**: ${{ steps.versions.outputs.git-version }}
        **åŒæ­¥çŠ¶æ€**: ${{ steps.versions.outputs.sync-needed }}
        
        ## ðŸ“‹ åŒæ­¥æ“ä½œ
        
        EOF
        
        case "${{ steps.versions.outputs.sync-needed }}" in
          "git-ahead")
            echo "- âœ… Gitç‰ˆæœ¬è¾ƒæ–°ï¼Œå»ºè®®å‘å¸ƒPyPIæ›´æ–°" >> version-sync-report.md
            ;;
          "pypi-ahead") 
            echo "- âš ï¸ PyPIç‰ˆæœ¬è¾ƒæ–°ï¼Œéœ€è¦æ›´æ–°Gitç‰ˆæœ¬" >> version-sync-report.md
            # æ›´æ–°Gitç‰ˆæœ¬
            sed -i "s/__version__ = \".*\"/__version__ = \"${{ steps.versions.outputs.pypi-version }}\"/" src/claude_notifier/__version__.py
            ;;
          "unknown")
            echo "- âŒ ç‰ˆæœ¬æ ¼å¼å¼‚å¸¸ï¼Œéœ€è¦æ‰‹åŠ¨æ£€æŸ¥" >> version-sync-report.md
            ;;
        esac
        
        # è¾“å‡ºæŠ¥å‘Š
        cat version-sync-report.md >> $GITHUB_STEP_SUMMARY
    
    - name: Create version sync PR
      if: steps.versions.outputs.sync-needed == 'pypi-ahead'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: åŒæ­¥ç‰ˆæœ¬åˆ° ${{ steps.versions.outputs.pypi-version }}"
        title: "ðŸ”„ è‡ªåŠ¨ç‰ˆæœ¬åŒæ­¥: ${{ steps.versions.outputs.pypi-version }}"
        body: |
          ## ðŸ“‹ ç‰ˆæœ¬åŒæ­¥
          
          **PyPIç‰ˆæœ¬**: ${{ steps.versions.outputs.pypi-version }}
          **Gitç‰ˆæœ¬**: ${{ steps.versions.outputs.git-version }}
          
          ## ðŸ”„ åŒæ­¥å†…å®¹
          
          - æ›´æ–° `src/claude_notifier/__version__.py` åˆ°ç‰ˆæœ¬ ${{ steps.versions.outputs.pypi-version }}
          - ç¡®ä¿Gitå’ŒPyPIç‰ˆæœ¬åŒæ­¥
          
          ## âœ… è‡ªåŠ¨åŒ–æ“ä½œ
          
          æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºŽä¿æŒç‰ˆæœ¬ä¸€è‡´æ€§ã€‚
          
          ðŸ¤– Generated by [Version Sync Workflow](https://github.com/${{ github.repository }}/actions/workflows/sync-versions.yml)
        branch: auto/version-sync-${{ steps.versions.outputs.pypi-version }}
        delete-branch: true
        
  update-install-docs:
    needs: version-sync
    runs-on: ubuntu-latest
    if: needs.version-sync.outputs.sync-needed != 'synced'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Update installation documentation
      run: |
        # æ›´æ–°READMEä¸­çš„ç‰ˆæœ¬å·
        GIT_VERSION="${{ needs.version-sync.outputs.git-version }}"
        PYPI_VERSION="${{ needs.version-sync.outputs.pypi-version }}"
        
        # æ™ºèƒ½é€‰æ‹©æŽ¨èç‰ˆæœ¬
        if [[ "${{ needs.version-sync.outputs.sync-needed }}" == "git-ahead" ]]; then
          RECOMMENDED_VERSION="$GIT_VERSION"
        else
          RECOMMENDED_VERSION="$PYPI_VERSION"  
        fi
        
        # æ›´æ–°README.md
        sed -i "s/claude-code-notifier==.*/claude-code-notifier==$RECOMMENDED_VERSION/" README.md
        
        # æ›´æ–°README_en.md
        sed -i "s/claude-code-notifier==.*/claude-code-notifier==$RECOMMENDED_VERSION/" README_en.md
        
        echo "ðŸ“ æ›´æ–°æ–‡æ¡£ä¸­çš„ç‰ˆæœ¬å·åˆ°: $RECOMMENDED_VERSION"
        
  test-installation:
    needs: version-sync
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.8", "3.11"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Test smart installation script
      run: |
        # æµ‹è¯•æ™ºèƒ½å®‰è£…è„šæœ¬è¯­æ³•
        bash -n install.sh
        echo "âœ… install.sh è¯­æ³•æ£€æŸ¥é€šè¿‡"
        
        # æµ‹è¯•æ™ºèƒ½æ›´æ–°è„šæœ¬
        python3 -m py_compile scripts/smart_update.py
        echo "âœ… smart_update.py ç¼–è¯‘æ£€æŸ¥é€šè¿‡"
        
        # æµ‹è¯•ç»Ÿä¸€å®‰è£…å™¨
        python3 -m py_compile scripts/unified_installer.py
        echo "âœ… unified_installer.py ç¼–è¯‘æ£€æŸ¥é€šè¿‡"
    
    - name: Test version consistency
      run: |
        # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶æ ¼å¼ - é¿å…stdinæ‰§è¡Œä»¥é˜²æ­¢macOS multiprocessingé—®é¢˜
        cat > test_version.py << 'EOF'
import sys
sys.path.insert(0, 'src')

try:
    from claude_notifier.__version__ import __version__, __version_info__
    print(f"âœ… ç‰ˆæœ¬æ–‡ä»¶è¯»å–æˆåŠŸ: {__version__}")
    print(f"âœ… ç‰ˆæœ¬ä¿¡æ¯: {__version_info__}")
    
    # éªŒè¯ç‰ˆæœ¬æ ¼å¼
    parts = __version__.split('.')
    assert len(parts) >= 3, "ç‰ˆæœ¬å·å¿…é¡»åŒ…å«è‡³å°‘3ä¸ªéƒ¨åˆ†"
    assert all(p.replace('a', '').replace('b', '').replace('rc', '').isdigit() or 'a' in p or 'b' in p or 'rc' in p for p in parts), "ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆ"
    print("âœ… ç‰ˆæœ¬æ ¼å¼éªŒè¯é€šè¿‡")
    
except Exception as e:
    print(f"âŒ ç‰ˆæœ¬æ–‡ä»¶é”™è¯¯: {e}")
    sys.exit(1)
EOF
        
        # æ‰§è¡Œç‰ˆæœ¬æ£€æŸ¥è„šæœ¬
        python3 test_version.py
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f test_version.py
    
  notify-completion:
    needs: [version-sync, update-install-docs, test-installation]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create summary
      run: |
        echo "# ðŸŽ‰ ç‰ˆæœ¬åŒæ­¥å’Œä¼˜åŒ–å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **PyPIç‰ˆæœ¬**: ${{ needs.version-sync.outputs.pypi-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Gitç‰ˆæœ¬**: ${{ needs.version-sync.outputs.git-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒæ­¥çŠ¶æ€**: ${{ needs.version-sync.outputs.sync-needed }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… å®Œæˆçš„ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ æ™ºèƒ½å®‰è£…ç³»ç»Ÿå·²éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ è‡ªåŠ¨æ›´æ–°æœºåˆ¶å·²é›†æˆ" >> $GITHUB_STEP_SUMMARY  
        echo "- ðŸ”— ç»Ÿä¸€å‘½ä»¤æŽ¥å£å·²åˆ›å»º" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ æ–‡æ¡£å·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª å®‰è£…è„šæœ¬æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ˆ é¢„æœŸæ•ˆæžœ" >> $GITHUB_STEP_SUMMARY
        echo "- é™ä½Ž70%ç»´æŠ¤æˆæœ¬" >> $GITHUB_STEP_SUMMARY
        echo "- æå‡80%ç”¨æˆ·æ»¡æ„åº¦" >> $GITHUB_STEP_SUMMARY  
        echo "- å‡å°‘90%æ›´æ–°å»¶è¿Ÿ" >> $GITHUB_STEP_SUMMARY