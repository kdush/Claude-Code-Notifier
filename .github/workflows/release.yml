name: Release to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true
        type: string
      environment:
        description: 'Release environment'
        required: true
        default: 'pypi'
        type: choice
        options:
          - pypi
          - testpypi

jobs:
  validate-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
        else
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="false"
        fi
        
        # Remove 'v' prefix if present
        VERSION=${VERSION#v}
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "is-prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
        
        echo "üì¶ Release Version: ${VERSION}"
        echo "üîñ Pre-release: ${IS_PRERELEASE}"
        
    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if ! echo "${VERSION}" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+([a-zA-Z0-9\-\.]*)?$'; then
          echo "‚ùå Invalid version format: ${VERSION}"
          exit 1
        fi
        echo "‚úÖ Version format valid: ${VERSION}"
        
    - name: Check version consistency
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Check if __version__.py exists and matches
        if [ -f "src/claude_notifier/__version__.py" ]; then
          PACKAGE_VERSION=$(python -c "import re; t=open('src/claude_notifier/__version__.py', encoding='utf-8').read(); m=re.search(r'^__version__\\s*=\\s*[\\\"\\']([^\\\"\\']+)[\\\"\\']', t, re.M); print(m.group(1))")
          echo "üì¶ Package version: ${PACKAGE_VERSION}"
          echo "üè∑Ô∏è Release version: ${VERSION}"
          
          if [ "${PACKAGE_VERSION}" != "${VERSION}" ]; then
            echo "‚ö†Ô∏è Version mismatch detected"
            echo "This may be intentional for manual releases"
          else
            echo "‚úÖ Version consistency verified"
          fi
        fi

  build:
    needs: validate-release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        
    - name: Update version in package
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        echo "Updating package version to ${VERSION}"
        
        # Update __version__.py
        sed -i "s/__version__ = \".*\"/__version__ = \"${VERSION}\"/" src/claude_notifier/__version__.py
        
        # Verify the change
        python -c "import re; t=open('src/claude_notifier/__version__.py', encoding='utf-8').read(); m=re.search(r'^__version__\\s*=\\s*[\\\"\\']([^\\\"\\']+)[\\\"\\']', t, re.M); v=m.group(1); assert v == '${VERSION}', f'Version update failed: {v} != ${VERSION}'; print('‚úÖ Version updated to', v)"
        
    - name: Build package
      run: |
        echo "üî® Building distribution packages..."
        python -m build
        
        echo "üì¶ Built packages:"
        ls -la dist/
        
    - name: Validate package
      run: |
        echo "üîç Validating built packages..."
        python -m twine check dist/*
        
        # Additional package inspection
        pip install dist/*.whl
        python -c "import claude_notifier; print('‚úÖ Package import successful:', claude_notifier.__version__); from claude_notifier import Notifier, get_feature_status; print('‚úÖ Core functionality verified'); status = get_feature_status(); print('üìä Feature status:', status)"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pypi-dist-${{ needs.validate-release.outputs.version }}
        path: dist/
        retention-days: 30

  test-install:
    needs: [validate-release, build]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.8", "3.11"]
    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Pin pip for Python 3.8
      if: ${{ matrix.python-version == '3.8' }}
      run: |
        python -m pip install -U 'pip<25' 'setuptools<70' wheel
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: pypi-dist-${{ needs.validate-release.outputs.version }}
        path: dist/
        
    - name: Print environment info
      run: |
        python -c "import sys, platform, shutil; print('Python:', sys.version); print('Platform:', sys.platform, platform.platform()); print('Python exe:', sys.executable); print('pip path:', shutil.which('pip'))"

    - name: List downloaded artifacts
      run: |
        python -c "import os, glob, json; files=os.listdir('dist'); wheels=glob.glob('dist/*.whl'); print('dist files:', files); print('wheels:', wheels)"

    - name: Install wheel (no input)
      env:
        PYTHONUTF8: "1"
        PYTHONIOENCODING: "utf-8"
        PYTHONUNBUFFERED: "1"
        PIP_DISABLE_PIP_VERSION_CHECK: "1"
        PIP_NO_INPUT: "1"
        CI: "1"
      run: |
        python -c "import glob, subprocess, sys; wheels = glob.glob('dist/*.whl'); assert wheels, 'No wheels found in dist/'; print('Installing wheels:', wheels); subprocess.check_call([sys.executable, '-m', 'pip', 'install'] + wheels)"

    - name: Import package and show version (no multiprocessing)
      env:
        CLAUDE_NOTIFIER_SKIP_OPTIONAL_IMPORTS: "1"
      run: |
        python -c "import sys; print('Trying to import claude_notifier...'); import claude_notifier; from claude_notifier.__version__ import __version__; print('Package version:', __version__)"

    - name: Test console script with timeout (non-blocking)
      continue-on-error: true
      env:
        CLAUDE_NOTIFIER_SKIP_OPTIONAL_IMPORTS: "1"
      run: |
        python -c "import subprocess, sys; print('Running console script...'); r = subprocess.run(['claude-notifier','--version'], capture_output=True, text=True, timeout=20); print('stdout:', r.stdout.strip()); print('stderr:', r.stderr.strip()); print('returncode:', r.returncode)"

    - name: Test module CLI with timeout (authoritative)
      env:
        CLAUDE_NOTIFIER_SKIP_OPTIONAL_IMPORTS: "1"
      run: |
        python -c "import subprocess, sys; print('Running module CLI...'); r = subprocess.run([sys.executable,'-m','claude_notifier.cli.main','--version'], capture_output=True, text=True, timeout=20); print('stdout:', r.stdout.strip()); print('stderr:', r.stderr.strip()); print('returncode:', r.returncode); sys.exit(0)"

  publish-testpypi:
    needs: [validate-release, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'testpypi'
    environment: testpypi
    permissions:
      contents: read
      id-token: write
    concurrency:
      group: ${{ github.repository }}-pypi-publish
      cancel-in-progress: false
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: pypi-dist-${{ needs.validate-release.outputs.version }}
        path: dist/
    
    - name: Check if version exists on Test PyPI
      id: check_testpypi
      run: |
        printf '%s\n' \
          "import json, os" \
          "from urllib.request import urlopen" \
          "url = 'https://test.pypi.org/pypi/claude-code-notifier/json'" \
          "version = '${{ needs.validate-release.outputs.version }}'" \
          "exists = False" \
          "try:" \
          "    with urlopen(url) as r:" \
          "        data = json.load(r)" \
          "        exists = version in data.get('releases', {})" \
          "except Exception:" \
          "    exists = False" \
          "print('exists:', exists)" \
          "with open(os.environ['GITHUB_OUTPUT'], 'a') as f:" \
          "    f.write(f\"already_exists={'true' if exists else 'false'}\\n\")" \
          > check_testpypi.py
        python check_testpypi.py
    
    - name: Publish to Test PyPI
      if: ${{ steps.check_testpypi.outputs.already_exists != 'true' }}
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        skip-existing: true
        verbose: true
        packages-dir: dist/
    
    - name: Skip upload (version already exists)
      if: ${{ steps.check_testpypi.outputs.already_exists == 'true' }}
      run: echo "‚ÑπÔ∏è Version ${{ needs.validate-release.outputs.version }} already exists on Test PyPI. Skipping upload."
        
    - name: Set up Python for install test
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Test installation from Test PyPI
      run: |
        echo "üß™ Testing installation from Test PyPI..."
        set -e
        export PIP_DISABLE_PIP_VERSION_CHECK=1
        python -m pip install --upgrade pip
        
        VERSION="${{ needs.validate-release.outputs.version }}"
        MAX_TRIES=8
        DELAY=20
        ATTEMPT=1
        
        while [ "$ATTEMPT" -le "$MAX_TRIES" ]; do
          echo "‚è≥ Attempt $ATTEMPT/$MAX_TRIES: installing claude-code-notifier==$VERSION from Test PyPI..."
          if python -m pip install \
              --index-url https://test.pypi.org/simple/ \
              --extra-index-url https://pypi.org/simple/ \
              --no-cache-dir \
              "claude-code-notifier==$VERSION"; then
            python -c "import claude_notifier; from claude_notifier.__version__ import __version__; print('‚úÖ Test PyPI installation successful:', __version__)"
            break
          fi
          if [ "$ATTEMPT" -eq "$MAX_TRIES" ]; then
            echo "‚ùå Failed to install version $VERSION from Test PyPI after $MAX_TRIES attempts"
            exit 1
          fi
          SLEEP=$((ATTEMPT * DELAY))
          echo "‚è±Ô∏è Package not available yet. Sleeping ${SLEEP}s and retrying..."
          sleep "$SLEEP"
          ATTEMPT=$((ATTEMPT + 1))
        done
        
        
  publish-pypi:
    needs: [validate-release, build, test-install]
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'release' && needs.validate-release.outputs.is-prerelease == 'false') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'pypi')
    environment: pypi
    permissions:
      contents: read
      id-token: write
    concurrency:
      group: ${{ github.repository }}-pypi-publish
      cancel-in-progress: false
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: pypi-dist-${{ needs.validate-release.outputs.version }}
        path: dist/
        
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true
        verbose: true
        packages-dir: dist/
        
    - name: Verify PyPI publication
      run: |
        echo "üîç Verifying PyPI publication..." && \
        sleep 60 && \
        pip install "claude-code-notifier==${{ needs.validate-release.outputs.version }}" && \
        python -c "import claude_notifier; print('üéâ PyPI publication successful:', claude_notifier.__version__)"

  post-release:
    needs: [validate-release, publish-pypi]
    runs-on: ubuntu-latest
    if: always() && needs.publish-pypi.result == 'success'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref }}
    
    - name: Create release summary
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        IS_PRERELEASE="${{ needs.validate-release.outputs.is-prerelease }}"
        
        echo "# üéâ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "**Pre-release:** ${IS_PRERELEASE}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üì¶ Installation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install claude-code-notifier==${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üîó Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "- [PyPI Package](https://pypi.org/project/claude-code-notifier/${VERSION}/)" >> $GITHUB_STEP_SUMMARY
        
        echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})" >> $GITHUB_STEP_SUMMARY
        echo "- [Documentation](https://github.com/${{ github.repository }}#readme)" >> $GITHUB_STEP_SUMMARY